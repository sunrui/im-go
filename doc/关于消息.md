# 关于消息

## 协议

```
- 指令交互由 http restful 完成
- 在线即时通讯由 grpc 完成
- 离线消息、推送则由 mqtt 完成
- 内部消息调度由 amqp 完成
```

## 认证流程

```
1、客户端通过 http restful 协议与服务器建立连接完成登录需求，同时返回当前会话的 sessionId。
2、客户端通过 grpc 协议将 sessionId 与服务器建立连接完成认证，同时开启 keep-alive 链接。
3、客户端通过 grpc 协议获取当前的 mqtt 的推送订阅 topic 号等待消息推送。
```

## 即时通讯流程

```
1、客户端通过 grpc 协议主动订阅离线消息从服务器。
2、客户端使用 grpc 相应的消息接口主动发送内容到服务器。
3、客户端收到 mqtt 推送的事件以后，通过相应的 grpc 接口去拉取消息。
```

## 客户端消息内部流程

```
1、客户端在收到消息以后，将在内存中保存一份消息，同时将消息写入 sqlite 数据库中。
2、界面提取消息时内存中不存在则从数据库提取，数据库没有则拉取网络内容后同时保存到数据库中。
3、发送消息时，先将 sequence 写入数据库中，再启动 grpc 发送消息，待服务器回执时，同时改掉内存和数据库的发送状态。
4、对失败的消息默认会按 sequence 只存在数据库中，重发时则从数据库移除同时移到最下面一个。
5、删除聊天记录时，同时从数据库中删除消息，同时从内存中删除消息。
```

## 客户端离线消息存储

```
1、数据库默认使用底层随机的码作为加密 key，将 sqlite 数据库加密。
2、根据消息类型不同，单聊为单独一张表，群聊为单独一张表，其它的类似均为单独一张表。
```

## 服务器内部流程

```
1、服务器在收到登录请求以后，将 sessionId 写入到数据库中，同时生成相应 topic 号到 mqtt 推送。
2、服务器通过 grpc 消息收到消息后，先写入到 amqp 相应的 inbox 队列中，同时开启离线消息存储、mqtt 推送的订阅。
3、当 mqtt 订阅收到消息时，判断此时是否存在 grpc 长连接的客户端，如果不存在则放弃本次消费，反之则使用 mqtt 推送告之 grpc 主动拉取消息。
```